name: FireGuard CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ------------------------------------------------------------------
  # JOB 1: BACKEND (FastAPI + uv)
  # ------------------------------------------------------------------
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install Dependencies
        # Installs dev dependencies (needed for tests/linting)
        run: uv sync --all-extras --dev

      - name: Run Linter (Ruff)
        # Ruff acts as both Linter (flake8) and Formatter (black)
        run: |
          uv run ruff check .
          uv run ruff format --check .

      - name: Run Tests
        # Runs pytest using the environment created by uv
        run: uv run pytest

      - name: Verify Docker Build
        # Ensures the Dockerfile is valid and the app builds successfully
        run: docker build . -t fireguard-backend:latest

  #------------------------------------------------
  # Job 2: INTELLIGENCE SYSTEM
  #------------------------------------------------
  intelligence-ci:
    name: Intelligence System CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./intelligence-system

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.12

      - name: Install Dependencies
        run: uv sync --all-extras --dev

      - name: Lint (Ruff)
        run: |
          uv run ruff check .
          uv run ruff format --check .

      # Add tests if you have them in intelligence-system/tests/
      # - name: Run Tests
      #   run: uv run pytest

      - name: Verify Docker Build
        run: docker build . -t fireguard-intelligence:latest

  # ------------------------------------------------------------------
  # JOB 3: FRONTEND (React + Vite)
  # ------------------------------------------------------------------
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run Linter
        # Checks for code quality issues
        run: npm run lint

      - name: Type Check (TypeScript)
        # Verifies no type errors exist
        run: npm run tsc -- --noEmit

      - name: Build for Production
        # Compiles the React app to static files (dist/)
        run: npm run build
